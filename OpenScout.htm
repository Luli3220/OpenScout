<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenScout - 开源人才智能雷达</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Phosphor Icons (for visuals) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Marked.js for Markdown Rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Custom Theme Configuration */
        :root {
            --bg-color: #fcfbf9;
            --card-bg: #ffffff;
            --text-main: #334155;
            --text-muted: #64748b;
            --accent: #ea580c;
            /* Burnt Orange */
            --border: #e2e8f0;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Inter', system-ui, sans-serif;
        }

        /* Animations */
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }

            100% {
                background-position: 1000px 0;
            }
        }

        .skeleton {
            animation: shimmer 2s infinite linear;
            background: linear-gradient(to right, #f1f5f9 4%, #e2e8f0 25%, #f1f5f9 36%);
            background-size: 1000px 100%;
            border-radius: 4px;
            display: inline-block;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translate3d(0, 20px, 0);
            }

            to {
                opacity: 1;
                transform: none;
            }
        }

        .fade-in-up {
            animation: fadeInUp 0.6s ease-out both;
        }

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }

        .cursor-blink::after {
            content: '_';
            animation: blink 1s step-end infinite;
            color: var(--accent);
            font-weight: bold;
        }

        /* Heatmap Styles */
        .heatmap-grid {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 1rem;
            justify-content: center;
        }

        .heatmap-cell {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            background-color: #ebedf0;
            /* default/0 */
        }

        .heatmap-cell[data-level="1"] {
            background-color: #9be9a8;
        }

        .heatmap-cell[data-level="2"] {
            background-color: #40c463;
        }

        .heatmap-cell[data-level="3"] {
            background-color: #30a14e;
        }

        .heatmap-cell[data-level="4"] {
            background-color: #216e39;
        }

        /* Chart Container Styling - Critical for Responsiveness */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 100%;
            height: 300px;
            /* Base height */
            max-height: 350px;
            margin-left: auto;
            margin-right: auto;
        }

        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }

        /* Card Styling */
        .scout-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            /* 12px */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform, box-shadow;
        }

        .scout-card:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transform: translateY(-4px) scale(1.02);
            border-color: var(--accent);
            z-index: 10;
        }

        .btn-primary {
            background-color: var(--text-main);
            color: white;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: var(--accent);
        }

        /* Ghost Button Styling */
        .btn-ghost {
            background-color: transparent;
            color: var(--text-muted);
            border: 1px solid transparent;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .btn-ghost:hover {
            background-color: #f1f5f9;
            /* Slate-100 */
            color: var(--text-main);
        }

        /* Highlight classes */
        .highlight-text {
            color: var(--accent);
            font-weight: 600;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 100;
            /* High z-index to sit on top */
            display: none;
            /* Hidden by default */
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-container {
            background-color: #ffffff;
            width: 800px;
            max-width: 90%;
            height: 80vh;
            /* Fixed height */
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-main);
        }

        .modal-close-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 1.5rem;
            transition: color 0.2s;
            padding: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close-btn:hover {
            color: var(--accent);
        }

        .modal-body {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
            color: var(--text-main);
            line-height: 1.6;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <!-- Navigation / Header -->
    <nav class="w-full bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <i class="ph ph-radar text-3xl text-orange-600"></i>
                    <span class="font-bold text-xl tracking-tight text-slate-800">OpenScout</span>
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-sm text-slate-500 hidden md:block">Powered by OpenDigger & MaxKB</span>
                    <button class="text-slate-600 hover:text-orange-600 transition-colors">
                        <i class="ph ph-github-logo text-2xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full space-y-8">

        <!-- 1. Search & Context Section -->
        <section class="text-center space-y-4 max-w-3xl mx-auto">
            <h1 class="text-3xl font-bold text-slate-800">开源人才智能雷达</h1>
            <p class="text-slate-600 leading-relaxed">
                OpenScout 利用 <strong>OpenDigger</strong> 的行为数据构建开发者画像，并结合 <strong>AI</strong> 大模型能力进行智能分析。
                输入 GitHub ID，立即获取该开发者的技能雷达、贡献习惯及岗位匹配度报告。
            </p>

            <div class="relative max-w-md mx-auto mt-6">
                <div class="flex shadow-sm rounded-md">
                    <input type="text" id="searchInput" placeholder="输入 GitHub ID (例如: torvalds)"
                        class="flex-1 block w-full rounded-l-md border-gray-300 focus:border-orange-500 focus:ring-orange-500 sm:text-sm p-3 border"
                        value="cescoffier">
                    <button id="searchBtn" type="button"
                        class="btn-primary inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-r-md">
                        <i class="ph ph-magnifying-glass mr-2 text-lg"></i> 分析
                    </button>
                </div>
                <!-- Presets for Demo -->
                <div class="mt-2 flex justify-center gap-2 text-xs text-slate-400">
                    <span>示例:</span>
                    <button class="hover:text-orange-600 underline demo-preset"
                        data-id="HansKristian-Work">HansKristian-Work (图形学)</button>
                    <button class="hover:text-orange-600 underline demo-preset" data-id="camilamaia">camilamaia
                        (K8s)</button>
                    <button class="hover:text-orange-600 underline demo-preset" data-id="cescoffier">cescoffier
                        (Java/Quarkus)</button>
                </div>
            </div>
        </section>

        <!-- DASHBOARD CONTAINER (Initially Hidden until search) -->
        <div id="dashboard" class="space-y-6 transition-opacity duration-500 opacity-100">

            <!-- 2. Profile & Multi-Agent Analysis -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Profile Card -->
                <div class="scout-card p-6 flex flex-col items-center text-center h-full">
                    <div
                        class="w-24 h-24 rounded-full bg-slate-100 mb-4 flex items-center justify-center border-2 border-orange-100 relative overflow-hidden">
                        <i class="ph ph-user text-4xl text-slate-400" id="avatarIcon"></i>
                        <img id="userAvatar" src="" alt="Avatar" class="absolute w-full h-full object-cover hidden">
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800" id="userName">User Name</h2>
                    <p class="text-sm text-orange-600 font-medium mb-4" id="userHandle">@handle</p>

                    <div class="grid grid-cols-2 gap-4 w-full border-t border-slate-100 pt-4">
                        <div class="text-center">
                            <span class="block text-xl font-bold text-slate-700" id="openRank">0.0</span>
                            <span class="text-xs text-slate-500">OpenRank</span>
                        </div>
                        <div class="text-center">
                            <span class="block text-xl font-bold text-slate-700" id="activityScore">0.0</span>
                            <span class="text-xs text-slate-500">月活跃度</span>
                        </div>
                    </div>
                </div>

                <!-- Agent 1: The Career Strategist -->
                <div class="scout-card p-6 flex flex-col h-full relative overflow-hidden">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="bg-indigo-100 p-2 rounded-md">
                            <i class="ph ph-strategy text-indigo-600 text-xl"></i>
                        </div>
                        <h3 class="font-bold text-slate-800">The Career Strategist</h3>
                    </div>
                    <div class="prose prose-sm text-slate-600 flex-grow overflow-y-auto max-h-64" id="careerContent">
                        <div class="flex items-center justify-center h-full text-slate-400 text-xs italic">
                            等待分析...
                        </div>
                    </div>
                </div>

                <!-- Agent 2: The Tech Stack Evaluator -->
                <div class="scout-card p-6 flex flex-col h-full relative overflow-hidden">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="bg-emerald-100 p-2 rounded-md">
                            <i class="ph ph-code text-emerald-600 text-xl"></i>
                        </div>
                        <h3 class="font-bold text-slate-800">The Tech Stack Evaluator</h3>
                    </div>
                    <div class="prose prose-sm text-slate-600 flex-grow overflow-y-auto max-h-64" id="techContent">
                        <div class="flex items-center justify-center h-full text-slate-400 text-xs italic">
                            等待分析...
                        </div>
                    </div>
                </div>

                <!-- Agent 3: The Project Analyst -->
                <div class="scout-card p-6 flex flex-col h-full relative overflow-hidden">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="bg-purple-100 p-2 rounded-md">
                            <i class="ph ph-kanban text-purple-600 text-xl"></i>
                        </div>
                        <h3 class="font-bold text-slate-800">The Project Analyst</h3>
                    </div>
                    <div class="prose prose-sm text-slate-600 flex-grow overflow-y-auto max-h-64" id="projectContent">
                        <div class="flex items-center justify-center h-full text-slate-400 text-xs italic">
                            等待分析...
                        </div>
                    </div>
                </div>

                <!-- Summary Agent: Chief Talent Officer -->
                <div
                    class="scout-card p-6 flex flex-col relative overflow-hidden border-t-4 border-t-orange-500 md:col-span-2 lg:col-span-4">
                    <div class="absolute top-0 right-0 p-4 opacity-5">
                        <i class="ph ph-seal-check text-9xl text-orange-600"></i>
                    </div>
                    <div class="flex items-center justify-between gap-3 mb-4 relative z-10">
                        <div class="flex items-center gap-3">
                            <div class="bg-orange-100 p-2 rounded-md">
                                <i class="ph ph-user-focus text-orange-600 text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-xl text-slate-800">The Chief Talent Officer</h3>
                                <p class="text-xs text-slate-500">综合评估报告</p>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row items-end sm:items-center gap-2">
                            <div id="keywordsContent"
                                class="flex flex-nowrap gap-2 max-w-[520px] overflow-x-auto text-sm text-slate-700">
                                <div class="text-slate-400 text-xs italic">等待分析...</div>
                            </div>
                            <button class="btn-ghost" id="viewReportBtn">
                                <i class="ph ph-arrows-out"></i> 全屏阅读
                            </button>
                        </div>
                    </div>
                    <div class="prose prose-sm text-slate-600 max-h-96 overflow-y-auto relative z-10"
                        id="summaryContent">
                        <div class="p-8 text-center text-slate-400">
                            <i class="ph ph-robot text-4xl mb-2 block"></i>
                            <span>正在等待各子 Agent 提交分析数据...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Metrics Grid (OpenDigger Data Visualization) -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                <!-- Chart 1: The Six-Dimensional Radar -->
                <div class="scout-card p-5 col-span-1 lg:col-span-1" id="radarCard">
                    <div class="mb-4 flex justify-between items-start">
                        <div>
                            <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                                <i class="ph ph-polygon text-orange-600"></i> 能力六维图
                            </h3>
                            <p class="text-xs text-slate-500 mt-1">融合 OpenDigger 算法与 GitHub 行为数据，六维量化开发者的开源价值。</p>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="radarChart"></canvas>
                    </div>
                    <div class="mt-4 pt-4 border-t border-slate-100">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs font-semibold text-slate-600">近一年活跃度 (Activity Heatmap)</span>
                        </div>
                        <div id="activityHeatmap" class="heatmap-grid" title="颜色越深代表该月 OpenRank/活跃度 越高">
                            <!-- Heatmap Cells Injected Here -->
                        </div>
                    </div>
                </div>

                <!-- Chart 2: Language & Tech Stack -->
                <div class="scout-card p-5 col-span-1 lg:col-span-1" id="stackCard">
                    <div class="mb-4">
                        <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                            <i class="ph ph-code text-orange-600"></i> 技术栈分布
                        </h3>
                        <p class="text-xs text-slate-500 mt-1">分析仓库语言构成，判断开发者主要技术领域。</p>
                    </div>
                    <div class="chart-container">
                        <canvas id="stackChart"></canvas>
                    </div>
                </div>

                <!-- Chart 3: OpenRank Trend -->
                <div class="scout-card p-5 col-span-1 lg:col-span-1 md:col-span-2" id="trendCard">
                    <div class="mb-4">
                        <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                            <i class="ph ph-trend-up text-orange-600"></i> OpenRank 走势
                        </h3>
                        <p class="text-xs text-slate-500 mt-1">OpenRank 长周期趋势，用于观察影响力变化。</p>
                    </div>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- 岗位匹配模拟器 已移除 -->

        </div>
    </main>

    <!-- Representative Repos (动态注入) -->
    <section id="repReposSection" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 w-full">
        <div class="scout-card p-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                        <i class="ph ph-github-logo text-orange-600"></i> 代表仓库
                    </h3>
                    <p class="text-xs text-slate-500 mt-1">按 Star 排序，显示 Stars / Forks / 贡献得分与仓库链接。</p>
                </div>
                <div class="flex items-center gap-2">
                    <div id="repReposPageInfo" class="text-xs text-slate-500 whitespace-nowrap"></div>
                    <select id="repReposPageSize"
                        class="text-xs border border-slate-200 rounded-md px-2 py-1 bg-white text-slate-700">
                        <option value="10">10/页</option>
                        <option value="20">20/页</option>
                        <option value="50">50/页</option>
                    </select>
                    <button class="btn-ghost px-2 py-1 text-xs disabled:opacity-50 disabled:cursor-not-allowed"
                        id="repReposPrevBtn">上一页</button>
                    <button class="btn-ghost px-2 py-1 text-xs disabled:opacity-50 disabled:cursor-not-allowed"
                        id="repReposNextBtn">下一页</button>
                </div>
            </div>
            <div id="repReposList" class="space-y-3">
                <!-- Filled by JS -->
            </div>
        </div>
    </section>

    <footer class="bg-white border-t border-gray-200 py-8 mt-8">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-slate-400 text-sm">&copy; 2025 OpenScout Project. Data provided by OpenDigger.</p>
        </div>
    </footer>

    <!-- Modal Component -->
    <div class="modal-overlay" id="auditModal">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title">智能人才画像报告</h3>
                <button class="modal-close-btn" id="closeModalBtn">
                    <i class="ph ph-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="prose prose-sm max-w-none text-slate-600" id="reportContent"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-ghost" id="closeModalFooterBtn">关闭</button>
            </div>
        </div>
    </div>
    <script>
        // --- 1. API INTERACTION ---

        // --- 2. CHART INSTANCES ---
        let radarChartInstance = null;
        let stackChartInstance = null;
        let trendChartInstance = null;
        let analyzeController = null;
        let analysisFullText = '';

        const auditModal = document.getElementById('auditModal');
        const viewReportBtn = document.getElementById('viewReportBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const closeModalFooterBtn = document.getElementById('closeModalFooterBtn');
        const reportContent = document.getElementById('reportContent');

        // Agent Content Elements
        const careerContentEl = document.getElementById('careerContent');
        const techContentEl = document.getElementById('techContent');
        const projectContentEl = document.getElementById('projectContent');
        const summaryContentEl = document.getElementById('summaryContent');
        const keywordsContentEl = document.getElementById('keywordsContent');
        const repReposListEl = document.getElementById('repReposList');
        const repReposPageInfoEl = document.getElementById('repReposPageInfo');
        const repReposPageSizeEl = document.getElementById('repReposPageSize');
        const repReposPrevBtn = document.getElementById('repReposPrevBtn');
        const repReposNextBtn = document.getElementById('repReposNextBtn');

        const repReposState = {
            repos: [],
            page: 1,
            pageSize: 10
        };

        function openModal() {
            if (!auditModal) return;
            auditModal.classList.add('active');
            document.body.style.overflow = 'hidden';
            // Render full report in modal
            renderFullReportInModal();
        }

        function closeModal() {
            if (!auditModal) return;
            auditModal.classList.remove('active');
            document.body.style.overflow = '';
        }

        function renderFullReportInModal() {
            // Concatenate all agent outputs for the modal view
            if (!reportContent) return;

            const careerText = careerContentEl ? careerContentEl.innerHTML : '';
            const techText = techContentEl ? techContentEl.innerHTML : '';
            const projectText = projectContentEl ? projectContentEl.innerHTML : '';
            const summaryText = summaryContentEl ? summaryContentEl.innerHTML : '';

            // Using simple concatenation with headers for the modal
            // Note: innerHTML already contains rendered HTML from marked.parse
            let fullHtml = `
                <h2 class="text-xl font-bold mb-4 text-indigo-700">1. The Career Strategist</h2>
                <div class="mb-8">${careerText}</div>
                
                <h2 class="text-xl font-bold mb-4 text-emerald-700">2. The Tech Stack Evaluator</h2>
                <div class="mb-8">${techText}</div>
                
                <h2 class="text-xl font-bold mb-4 text-purple-700">3. The Project Analyst</h2>
                <div class="mb-8">${projectText}</div>
                
                <hr class="my-6 border-slate-200">
                
                <h2 class="text-2xl font-bold mb-4 text-orange-700">Chief Talent Officer Summary</h2>
                <div>${summaryText}</div>
            `;

            reportContent.innerHTML = fullHtml;
        }

        function setAgentLoading(isLoading) {
            const loadingHtml = `
                <div class="flex flex-col items-center justify-center h-full text-slate-400 space-y-3 p-6">
                    <i class="ph ph-spinner animate-spin text-2xl"></i>
                    <span class="text-xs italic">正在进行深度分析...</span>
                </div>
            `;
            const waitingHtml = `
                <div class="flex items-center justify-center h-full text-slate-400 text-xs italic">
                    等待分析...
                </div>
            `;

            const html = isLoading ? loadingHtml : waitingHtml;

            [careerContentEl, techContentEl, projectContentEl, summaryContentEl].forEach(el => {
                if (el) el.innerHTML = html;
            });

            if (keywordsContentEl) {
                keywordsContentEl.innerHTML = isLoading
                    ? '<div class="flex items-center gap-2 text-slate-400 text-xs italic"><i class="ph ph-spinner animate-spin"></i><span>关键词生成中...</span></div>'
                    : '<div class="text-slate-400 text-xs italic">等待分析...</div>';
            }
        }

        function updateAgentContent(element, text) {
            if (element) {
                element.innerHTML = marked.parse(text || '无数据');
            }
        }

        function extractStrictJsonObject(text) {
            if (!text) return null;
            let s = String(text).trim();
            const fenceMatch = s.match(/```(?:json)?\s*([\s\S]*?)\s*```/i);
            if (fenceMatch && fenceMatch[1]) s = fenceMatch[1].trim();
            const start = s.indexOf('{');
            const end = s.lastIndexOf('}');
            if (start >= 0 && end > start) s = s.slice(start, end + 1).trim();
            try {
                const obj = JSON.parse(s);
                if (!obj || typeof obj !== 'object' || Array.isArray(obj)) return null;
                return obj;
            } catch {
                return null;
            }
        }

        function splitKeywords(rawValue) {
            const value = (rawValue ?? '').toString().trim();
            return value
                ? value.split(/[,，\n]/).map(v => v.trim()).filter(Boolean)
                : [];
        }

        function formatKeywordsCompact(rawValue) {
            const parts = splitKeywords(rawValue);
            if (!parts.length) return '';
            const shown = parts.slice(0, 3).join(' / ');
            const more = parts.length > 3 ? ` …(+${parts.length - 3})` : '';
            return `${shown}${more}`;
        }

        function renderKeywordChip(rawValue) {
            // 处理内容：格式化并去掉多余符号
            const value = formatKeywordsCompact(rawValue);

            // 如果依然为空，则不创建标签
            if (!value || value === '无') return document.createDocumentFragment();

            const chip = document.createElement('span');
            chip.className = 'inline-flex items-center px-3 py-1 rounded-full bg-orange-100 text-orange-700 text-xs whitespace-nowrap shadow-sm font-bold border border-orange-200';
            chip.textContent = value;

            return chip;
        }

        function updateKeywordsContent(element, text) {
            if (!element) return;
            const obj = extractStrictJsonObject(text);

            // 如果解析失败
            if (!obj) {
                element.innerHTML = '<div class="text-slate-400 text-xs italic">数据解析中...</div>';
                return;
            }

            // 优先获取指定的键，如果没有，则获取对象中前三个非空的字符串值
            const values = [
                obj.tech_core,
                obj.career_persona,
                obj.engineering_trait
            ].filter(v => v); // 过滤掉空值

            // 容错处理：如果指定的键都是空的，就尝试拿对象里前3个有值的属性
            if (values.length === 0) {
                Object.values(obj).forEach(val => {
                    if (val && typeof val === 'string' && values.length < 3) {
                        values.push(val);
                    }
                });
            }

            element.innerHTML = '';

            if (values.length === 0) {
                element.innerHTML = '<div class="text-slate-400 text-xs italic">暂无关键词</div>';
                return;
            }

            // 渲染找到的所有关键词
            values.forEach(val => {
                element.appendChild(renderKeywordChip(val));
            });
        }

        function renderRepresentativeReposPage() {
            if (!repReposListEl) return;

            const total = Array.isArray(repReposState.repos) ? repReposState.repos.length : 0;
            const pageSize = Math.max(1, Number(repReposState.pageSize) || 10);
            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            const page = Math.min(Math.max(1, Number(repReposState.page) || 1), totalPages);
            repReposState.page = page;

            const startIndex = (page - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, total);
            const pageRepos = repReposState.repos.slice(startIndex, endIndex);

            if (repReposPageInfoEl) {
                repReposPageInfoEl.textContent = total
                    ? `第 ${page}/${totalPages} 页 · ${startIndex + 1}-${endIndex} / ${total}`
                    : '';
            }
            if (repReposPrevBtn) repReposPrevBtn.disabled = page <= 1;
            if (repReposNextBtn) repReposNextBtn.disabled = page >= totalPages;

            if (!total) {
                repReposListEl.innerHTML = '<p class="text-sm text-slate-500">未找到代表仓库。</p>';
                return;
            }

            const outer = document.createDocumentFragment();
            pageRepos.forEach(r => {
                const row = document.createElement('div');
                row.className = 'flex items-center justify-between p-3 bg-white border border-slate-100 rounded-md';

                const left = document.createElement('div');
                left.className = 'flex items-start gap-3';
                const meta = document.createElement('div');
                const link = document.createElement('a');
                link.className = 'font-medium text-slate-800 hover:underline';
                link.href = r.html_url || '#';
                link.target = '_blank';
                link.rel = 'noopener';
                link.textContent = (r.full_name || r.name || 'Unknown Repo');

                const desc = document.createElement('div');
                desc.className = 'text-xs text-slate-500';
                desc.textContent = r.description || '';

                meta.appendChild(link);
                meta.appendChild(desc);
                left.appendChild(meta);

                const right = document.createElement('div');
                right.className = 'text-sm text-slate-600 flex items-center gap-4';
                const stars = document.createElement('div');
                stars.innerHTML = `<i class="ph ph-star text-orange-500 mr-1"></i> ${r.stars || 0}`;
                const forks = document.createElement('div');
                forks.innerHTML = `<i class="ph ph-git-branch text-slate-400 mr-1"></i> ${r.forks || 0}`;
                const score = document.createElement('div');
                const scoreVal = Number(r.contribution_score || 0);
                score.innerHTML = `<strong class="text-slate-800">${Number.isFinite(scoreVal) ? scoreVal.toFixed(2) : 0}</strong>`;
                right.appendChild(stars);
                right.appendChild(forks);
                right.appendChild(score);

                row.appendChild(left);
                row.appendChild(right);
                outer.appendChild(row);
            });

            repReposListEl.innerHTML = '';
            repReposListEl.appendChild(outer);
        }

        async function startAnalyze(username) {
            if (analyzeController) analyzeController.abort();
            analyzeController = new AbortController();

            setAgentLoading(true);

            try {
                const response = await fetch(`/api/analyze/${username}`, { signal: analyzeController.signal });

                if (!response.ok) {
                    const errMsg = `请求失败：${response.status}`;
                    [careerContentEl, techContentEl, projectContentEl, summaryContentEl, keywordsContentEl].forEach(el => {
                        if (el) el.innerHTML = `<div class="text-red-500">${errMsg}</div>`;
                    });
                    return;
                }

                // Expecting full JSON response with answer_list
                const data = await response.json();

                // Parse answer_list from choices[0]
                // Structure: choices[0].answer_list = [ {content: "...", ...}, ... ]
                let agentsData = [];
                if (data.choices && data.choices.length > 0 && data.choices[0].answer_list) {
                    agentsData = data.choices[0].answer_list;
                } else if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                    // Fallback if structure is different
                    agentsData = [{ content: data.choices[0].message.content }];
                }

                // Map to Cards (Indices based on observed order in intro.md)
                // 0: Career Strategist
                // 1: Tech Stack Evaluator
                // 2: Project Analyst
                // 3: Chief Talent Officer (Summary)

                if (agentsData.length >= 1) updateAgentContent(careerContentEl, agentsData[0].content);
                else updateAgentContent(careerContentEl, "未收到 Career Strategist 数据");

                if (agentsData.length >= 2) updateAgentContent(techContentEl, agentsData[1].content);
                else updateAgentContent(techContentEl, "未收到 Tech Stack Evaluator 数据");

                if (agentsData.length >= 3) updateAgentContent(projectContentEl, agentsData[2].content);
                else updateAgentContent(projectContentEl, "未收到 Project Analyst 数据");

                if (agentsData.length >= 4) updateAgentContent(summaryContentEl, agentsData[3].content);
                else if (agentsData.length === 1) {
                    // If only one big message, put it in summary? Or try to split?
                    // For now, if only 1 item, put it in summary
                    updateAgentContent(summaryContentEl, agentsData[0].content);
                    updateAgentContent(careerContentEl, "数据合并显示在总览中");
                    updateAgentContent(techContentEl, "数据合并显示在总览中");
                    updateAgentContent(projectContentEl, "数据合并显示在总览中");
                } else {
                    updateAgentContent(summaryContentEl, "未收到 Chief Talent Officer 总结数据");
                }

                if (agentsData.length >= 5) {
                    const last = agentsData[agentsData.length - 1];
                    updateKeywordsContent(keywordsContentEl, last && last.content);
                } else {
                    if (keywordsContentEl) {
                        keywordsContentEl.innerHTML = '<div class="text-slate-400 text-xs italic">未收到关键词数据。</div>';
                    }
                }

            } catch (err) {
                if (err && err.name === 'AbortError') return;
                const errMsg = `分析中断：${err.message || String(err)}`;
                [careerContentEl, techContentEl, projectContentEl, summaryContentEl, keywordsContentEl].forEach(el => {
                    if (el) el.innerHTML = `<div class="text-red-500">${errMsg}</div>`;
                });
            }
        }

        // --- 3. INIT FUNCTION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Setup Listeners
            document.getElementById('searchBtn').addEventListener('click', handleSearch);
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleSearch();
            });
            document.querySelectorAll('.demo-preset').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.getElementById('searchInput').value = e.target.dataset.id;
                    handleSearch();
                });
            });

            if (repReposPageSizeEl) {
                repReposPageSizeEl.addEventListener('change', () => {
                    repReposState.pageSize = Number(repReposPageSizeEl.value) || 10;
                    repReposState.page = 1;
                    renderRepresentativeReposPage();
                });
                repReposState.pageSize = Number(repReposPageSizeEl.value) || 10;
            }
            if (repReposPrevBtn) {
                repReposPrevBtn.addEventListener('click', () => {
                    repReposState.page = Math.max(1, (Number(repReposState.page) || 1) - 1);
                    renderRepresentativeReposPage();
                });
            }
            if (repReposNextBtn) {
                repReposNextBtn.addEventListener('click', () => {
                    repReposState.page = (Number(repReposState.page) || 1) + 1;
                    renderRepresentativeReposPage();
                });
            }

            const defaultUsername = document.getElementById('searchInput').value.trim() || 'cescoffier';
            loadProfile(defaultUsername);
        });

        if (viewReportBtn) viewReportBtn.addEventListener('click', openModal);
        if (closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
        if (closeModalFooterBtn) closeModalFooterBtn.addEventListener('click', closeModal);
        if (auditModal) {
            auditModal.addEventListener('click', (e) => {
                if (e.target === auditModal) closeModal();
            });
        }

        let miningInterval = null;

        function showMiningState(username) {
            // Update UI to show mining status
            document.getElementById('userName').textContent = username;
            document.getElementById('userBio').textContent = "Data mining in progress... Please wait.";

            // Show a loading spinner or similar on the radar chart
            const radarCanvas = document.getElementById('radarChart');
            const ctx = radarCanvas.getContext('2d');
            ctx.clearRect(0, 0, radarCanvas.width, radarCanvas.height);
            ctx.font = "20px Arial";
            ctx.fillStyle = "gray";
            ctx.textAlign = "center";
            ctx.fillText("Mining Data...", radarCanvas.width / 2, radarCanvas.height / 2);

            // Poll every 5 seconds
            if (!miningInterval) {
                miningInterval = setInterval(() => {
                    loadProfile(username);
                }, 5000);
            }
        }

        // --- 4. CORE LOGIC ---
        async function handleSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;
            await loadProfile(query);
        }

        async function loadProfile(username) {
            try {
                setLoadingState(true);
                startAnalyze(username);

                const avatarIcon = document.getElementById('avatarIcon');
                const userAvatar = document.getElementById('userAvatar');
                if (userAvatar) {
                    userAvatar.classList.add('hidden');
                    userAvatar.src = '';
                }
                if (avatarIcon) {
                    avatarIcon.classList.remove('hidden');
                }

                const [radarRes, githubRes] = await Promise.allSettled([
                    fetch(`/api/radar/${username}`),
                    fetch(`/api/github/${username}`)
                ]);

                if (radarRes.status !== 'fulfilled' || !radarRes.value.ok) {
                    const status = radarRes.status === 'fulfilled' ? radarRes.value.status : 'network';
                    throw new Error(`Radar API Error: ${status}`);
                }

                const data = await radarRes.value.json();

                if (data.mining) {
                    // Mining in progress
                    showMiningState(username);
                    return;
                }

                if (!data.found) {
                    alert('User not found in local database and mining failed.');
                    return;
                }

                // Clear any mining interval if successful
                if (miningInterval) {
                    clearInterval(miningInterval);
                    miningInterval = null;
                }

                let displayLogin = data.username;
                let displayName = data.username;

                if (githubRes.status === 'fulfilled' && githubRes.value.ok) {
                    const gh = await githubRes.value.json();
                    displayLogin = gh.login || displayLogin;
                    displayName = gh.name || gh.login || displayName;

                    if (userAvatar && gh.avatar_url) {
                        userAvatar.src = gh.avatar_url;
                        userAvatar.classList.remove('hidden');
                        if (avatarIcon) avatarIcon.classList.add('hidden');
                    }
                }

                setLoadingState(false);

                document.getElementById('userName').textContent = displayName || username;
                document.getElementById('userHandle').textContent = `@${displayLogin || username}`;

                // If data found
                const orVal = data.openrank_sum || 0;
                const actVal = data.activity_sum || 0;

                // Animate Numbers
                animateValue('openRank', 0, orVal, 1000);
                animateValue('activityScore', 0, actVal, 1000);

                if (data.found) {
                    renderRadar(data.radar);
                    await fetchAndRenderTechStack(username);
                    await fetchAndRenderRepresentativeRepos(username);
                    renderTrend(data.openrank_labels, data.openrank_series);
                    renderHeatmap(data.openrank_labels, data.openrank_series);
                } else {
                    renderRadar(data.radar);
                    await fetchAndRenderTechStack(username);
                    await fetchAndRenderRepresentativeRepos(username);
                    renderTrend(data.openrank_labels, data.openrank_series);
                    renderHeatmap([], []);
                }

                triggerEntranceAnimations();

            } catch (e) {
                console.error("Error loading profile:", e);
                setLoadingState(false);
                alert("无法连接到后端服务器，请确保 server.py 正在运行。");
            }
        }

        function getStrongestDim(scores) {
            const labels = ['影响力', '贡献度', '维护力', '活跃度', '多样性', '代码能力'];
            let maxI = 0;
            for (let i = 1; i < scores.length; i++) {
                if (scores[i] > scores[maxI]) maxI = i;
            }
            return labels[maxI];
        }

        // --- UI Animation Helpers ---

        function animateValue(objId, start, end, duration) {
            const obj = document.getElementById(objId);
            if (!obj) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const val = progress * (end - start) + start;
                obj.textContent = val.toFixed(2);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        function setLoadingState(isLoading) {
            const els = ['userName', 'userHandle', 'openRank', 'activityScore'];
            if (isLoading) {
                document.getElementById('userName').innerHTML = '<span class="skeleton" style="width: 120px; height: 32px;"></span>';
                document.getElementById('userHandle').innerHTML = '<span class="skeleton" style="width: 80px; height: 20px;"></span>';
                document.getElementById('openRank').innerHTML = '<span class="skeleton" style="width: 60px; height: 32px;"></span>';
                document.getElementById('activityScore').innerHTML = '<span class="skeleton" style="width: 60px; height: 32px;"></span>';

                // Reset Animations
                document.getElementById('radarCard').classList.remove('fade-in-up');
                document.getElementById('stackCard').classList.remove('fade-in-up');
                document.getElementById('trendCard').classList.remove('fade-in-up');
                document.getElementById('radarCard').style.opacity = '0';
                document.getElementById('stackCard').style.opacity = '0';
                document.getElementById('trendCard').style.opacity = '0';
            } else {
                // Content will be filled by data
            }
        }

        function triggerEntranceAnimations() {
            const cards = ['radarCard', 'stackCard', 'trendCard'];
            cards.forEach((id, index) => {
                const el = document.getElementById(id);
                if (el) {
                    el.style.animationDelay = `${index * 150}ms`;
                    el.classList.add('fade-in-up');

                    // Remove class after animation to allow hover transform to work cleanly
                    el.addEventListener('animationend', () => {
                        el.classList.remove('fade-in-up');
                        el.style.animationDelay = '';
                        el.style.opacity = '1';
                    }, { once: true });
                }
            });
        }

        function renderHeatmap(labels, seriesData) {
            const container = document.getElementById('activityHeatmap');
            if (!container) return;
            container.innerHTML = '';

            // seriesData is [val, val, val...] monthly.
            // We want last 12 months.
            const data = (seriesData || []).slice(-12);
            const lbls = (labels || []).slice(-12);

            // Normalize for color: 0-100 scale? OpenRank can be anything.
            // Let's assume max in series is 100% intensity or use a fixed scale.
            // OpenRank can be 200, 300.
            // We'll use relative scale based on max value in the set.
            const maxVal = Math.max(...data, 10);

            data.forEach((val, index) => {
                const div = document.createElement('div');
                div.className = 'heatmap-cell';
                const label = lbls[index] || 'Unknown';
                div.title = `${label}: ${val.toFixed(2)}`;

                // Calculate level 0-4
                let level = 0;
                if (val > 0) {
                    const ratio = val / maxVal;
                    if (ratio > 0.75) level = 4;
                    else if (ratio > 0.5) level = 3;
                    else if (ratio > 0.25) level = 2;
                    else level = 1;
                }
                div.setAttribute('data-level', level);
                container.appendChild(div);
            });
        }


        // --- 5. VISUALIZATION FUNCTIONS (Chart.js) ---

        // Fetch tech stack for a user, aggregate top 4 languages and group rest into '其他', then render
        async function fetchAndRenderTechStack(username) {
            try {
                const res = await fetch(`/api/tech_stack/${username}`);
                if (!res.ok) {
                    renderStack({ labels: ['N/A'], data: [0] });
                    return;
                }
                const tech = await res.json();
                const langTotals = {};
                if (Array.isArray(tech)) {
                    tech.forEach(repo => {
                        const lb = repo.languages_breakdown || repo.languages || {};
                        for (const [lang, val] of Object.entries(lb || {})) {
                            const num = typeof val === 'number' ? val : parseFloat(val) || 0;
                            if (!lang) continue;
                            langTotals[lang] = (langTotals[lang] || 0) + num;
                        }
                    });
                }

                const entries = Object.entries(langTotals);
                if (!entries.length) {
                    renderStack({ labels: ['N/A'], data: [0] });
                    return;
                }

                entries.sort((a, b) => b[1] - a[1]);
                const top = entries.slice(0, 4);
                const rest = entries.slice(4);
                const restSum = rest.reduce((s, e) => s + e[1], 0);

                const selected = top.slice();
                if (restSum > 0) selected.push(['其他', restSum]);

                const total = selected.reduce((s, e) => s + e[1], 0) || 1;
                let labels = selected.map(e => e[0]);
                let data = selected.map(e => Math.round((e[1] / total) * 100));

                // adjust rounding to ensure sum == 100
                const sum = data.reduce((a, b) => a + b, 0);
                if (sum !== 100 && data.length > 0) {
                    data[data.length - 1] += 100 - sum;
                }

                renderStack({ labels, data });
            } catch (e) {
                renderStack({ labels: ['N/A'], data: [0] });
            }
        }

        function renderRadar(dataPoints) {
            const canvas = document.getElementById('radarChart');
            const ctx = canvas.getContext('2d');
            if (radarChartInstance) radarChartInstance.destroy();

            // Gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, 'rgba(234, 88, 12, 0.4)');
            gradient.addColorStop(1, 'rgba(234, 88, 12, 0.05)');

            radarChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['影响力', '贡献度', '维护力', '活跃度', '多样性', '代码能力'],
                    datasets: [{
                        label: '能力评分',
                        data: dataPoints,
                        backgroundColor: gradient,
                        borderColor: 'rgba(234, 88, 12, 1)',
                        pointBackgroundColor: 'rgba(234, 88, 12, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(234, 88, 12, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    scales: {
                        r: {
                            angleLines: { color: '#e2e8f0' },
                            grid: { color: '#e2e8f0' },
                            pointLabels: {
                                font: { size: 12, family: 'Inter' },
                                color: '#64748b'
                            },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `Score: ${context.raw}`;
                                },
                                afterLabel: function (context) {
                                    const descriptions = {
                                        '影响力': '衡量社区声望与项目受关注度 (Stars, Forks, OpenRank)。',
                                        '贡献度': '衡量外部代码贡献能力 (Merged PRs, Issues)。',
                                        '维护力': '衡量项目管理与代码把控能力 (Merge PRs, Reviews)。',
                                        '活跃度': '衡量技术讨论与互动投入 (Issue/PR Comments)。',
                                        '多样性': '衡量技术栈广度与领域丰富度 (Languages, Topics)。',
                                        '代码能力': '衡量代码技术含金量与工程规范 (Core Contribution)。'
                                    };
                                    return descriptions[context.label] || '';
                                }
                            },
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            padding: 10,
                            bodyFont: { size: 12 },
                            titleFont: { size: 13, weight: 'bold' }
                        }
                    }
                }
            });
        }

        function renderStack(stackData) {
            const ctx = document.getElementById('stackChart').getContext('2d');
            if (stackChartInstance) stackChartInstance.destroy();

            const palette = ['#ea580c', '#334155', '#94a3b8', '#cbd5e1', '#f97316'];
            const bg = (palette.slice(0, (stackData.labels || []).length));

            stackChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: stackData.labels,
                    datasets: [{
                        label: '代码占比 (%)',
                        data: stackData.data,
                        backgroundColor: bg,
                        borderRadius: 4,
                        maxBarThickness: 40
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    layout: { padding: { left: 28, right: 8, top: 8, bottom: 8 } },
                    indexAxis: 'y', // Horizontal bar
                    scales: {
                        x: { display: false, beginAtZero: true },
                        y: {
                            grid: { display: false },
                            ticks: { font: { family: 'Inter', size: 14 }, color: '#64748b' },
                            offset: true
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: true }
                    }
                }
            });
        }

        function renderTrend(labels, trendData) {
            const canvas = document.getElementById('trendChart');
            const ctx = canvas.getContext('2d');
            if (trendChartInstance) trendChartInstance.destroy();
            const safeLabels = Array.isArray(labels) && labels.length ? labels : ['N/A'];
            const safeData = Array.isArray(trendData) && trendData.length ? trendData : [0];

            // Gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, 'rgba(51, 65, 85, 0.2)');
            gradient.addColorStop(1, 'rgba(51, 65, 85, 0.0)');

            trendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: safeLabels,
                    datasets: [{
                        label: 'OpenRank',
                        data: safeData,
                        borderColor: '#334155',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        tension: 0.4, // Smooth curve
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    interaction: {
                        intersect: false,
                        mode: 'index',
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#f1f5f9' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { maxRotation: 0, autoSkip: true }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(15, 23, 42, 0.9)'
                        }
                    }
                }
            });
        }

        // --- Representative Repos ---
        async function fetchAndRenderRepresentativeRepos(username) {
            try {
                const res = await fetch(`/api/representative/${username}`);
                if (!res.ok) {
                    if (repReposListEl) repReposListEl.innerHTML = '<p class="text-sm text-slate-500">无法获取代表仓库数据。</p>';
                    if (repReposPageInfoEl) repReposPageInfoEl.textContent = '';
                    return;
                }
                const repos = await res.json();
                if (!Array.isArray(repos) || repos.length === 0) {
                    repReposState.repos = [];
                    repReposState.page = 1;
                    renderRepresentativeReposPage();
                    return;
                }

                repReposState.repos = repos;
                repReposState.page = 1;
                renderRepresentativeReposPage();
            } catch (e) {
                if (repReposListEl) repReposListEl.innerHTML = '<p class="text-sm text-slate-500">加载代表仓库失败。</p>';
                if (repReposPageInfoEl) repReposPageInfoEl.textContent = '';
            }
        }

        // 岗位匹配模拟器逻辑已移除

    </script>
</body>

</html>