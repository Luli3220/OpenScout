{
  "username": "kallydev",
  "agent_b_context": "\n=== PR #118 in elizaos-plugins/registry (Stars: 66) ===\n\n=== PR #327 in RSS3-Network/Global-Indexer (Stars: 21) ===\nFile: internal/database/dialer/cockroachdb/client_stake.go\nPatch:\n@@ -345,16 +345,34 @@ func (c *client) FindStakeStaker(ctx context.Context, address common.Address) (*\n \n \t/*\n \t\tSELECT\n-\t\t\tcoalesce(sum(value), 0) AS staked_tokens\n+\t\t    coalesce(sum(\n+\t\t        CASE\n+\t\t            WHEN transactions.type = 'stake' AND events.type = 'staked' THEN value\n+\t\t            WHEN transactions.type = 'unstake' AND events.type = 'claimed' THEN -value\n+\t\t            ELSE 0\n+\t\t        END\n+\t\t        ), 0) AS total_staked_tokens\n \t\tFROM stake.transactions\n-\t\tWHERE user = $1 AND type = 'stake' AND finalized;\n+\t\t         LEFT JOIN stake.events ON transactions.id = events.id\n+\t\tWHERE transactions.user = $1 AND transactions.finalized;\n \t*/\n \n-\tif err := databaseTransaction.\n-\t\tSelect(\"coalesce(sum(value), 0) AS staked_tokens\").\n+\tif err := databaseTransaction.Debug().\n+\t\tSelect(`\n+\t\t\tcoalesce(sum(\n+\t\t\t\tCASE\n+\t\t\t\t\tWHEN transactions.type = ? AND events.type = ? THEN value\n+\t\t\t\t\tWHEN transactions.type = ? AND events.type = ? THEN -value\n+\t\t\t\t\tELSE 0\n+\t\t\t\tEND\n+\t\t\t), 0) AS\n... (truncated)\n\n\n=== PR #320 in RSS3-Network/Global-Indexer (Stars: 21) ===\nFile: internal/database/client.go\nPatch:\n@@ -85,6 +85,7 @@ type Client interface {\n \tUpdateStakeChipsFinalizedByBlockNumber(ctx context.Context, blockNumber uint64) error\n \tDeleteStakeChipsByBlockNumber(ctx context.Context, blockNumber uint64) error\n \tFindStakeStakings(ctx context.Context, query schema.StakeStakingsQuery) ([]*schema.StakeStaking, error)\n+\tFindStakeStaker(ctx context.Context, address common.Address) (*schema.StakeStaker, error)\n \tSaveStakeTransaction(ctx context.Context, stakeTransaction *schema.StakeTransaction) error\n \tSaveStakeEvent(ctx context.Context, stakeEvent *schema.StakeEvent) error\n \tDeleteStakeTransactionsByBlockNumber(ctx context.Context, blockNumber uint64) error\n\nFile: internal/database/dialer/cockroachdb/client_stake.go\nPatch:\n@@ -337,6 +337,69 @@ func (c *client) FindStakeStakings(ctx context.Context, query schema.StakeStakin\n \treturn results, nil\n }\n \n+func (c *client) FindStakeStaker(ctx context.Context, address common.Address) (*schema.StakeStaker, error) {\n+\tdatabaseTransaction := c.database.WithContext(ctx).Begin(&sql.TxOptions{ReadOnly: true})\n+\tdefer databaseTransaction.Rollback()\n+\n+\tvar totalStakedTokens decimal.Decimal\n+\n+\t/*\n+\t\tSELECT\n+\t\t\tcoalesce(sum(value), 0) AS staked_tokens\n+\t\tFROM stake.transactions\n+\t\tWHERE user = $1 AND type = 'stake' AND finalized;\n+\t*/\n+\n+\tif err := databaseTransaction.\n+\t\tSelect(\"coalesce(sum(value), 0) AS staked_tokens\").\n+\t\tTable((*table.StakeTransaction).TableName(nil)).\n+\t\tWhere(`\"user\" = ? AND type = 'stake' AND finalized`, address.String()).\n+\t\tPluck(\"staked_tokens\", &totalStakedTokens).\n+\t\tError; err != nil && !errors.Is(err, gorm.ErrRecordNotFound) {\n+\t\treturn nil, err\n+\t}\n+\n+\t/*\n+\t\tSELECT\n+\t\t\tcount(node) AS staked_nodes,\n+\t\t\tsum(count) \tAS owned_chips,\n+\t\t\tsum\n... (truncated)\n\nFile: internal/service/hub/handler/nta/staker.go\nPatch:\n@@ -0,0 +1,37 @@\n+package nta\n+\n+import (\n+\t\"fmt\"\n+\t\"net/http\"\n+\n+\t\"github.com/ethereum/go-ethereum/common\"\n+\t\"github.com/labstack/echo/v4\"\n+\t\"github.com/rss3-network/global-indexer/schema\"\n+)\n+\n+type GetStakerRequest struct {\n+\tAddress common.Address `param:\"address\" validate:\"required\"`\n+}\n+\n+type GetStakerResponse schema.StakeStaker\n+\n+func (n *NTA) GetStaker(c echo.Context) error {\n+\tvar request GetStakerRequest\n+\n+\tif err := c.Bind(&request); err != nil {\n+\t\treturn fmt.Errorf(\"bind request: %w\", err)\n+\t}\n+\n+\tif err := c.Validate(&request); err != nil {\n+\t\treturn fmt.Errorf(\"validate request: %w\", err)\n+\t}\n+\n+\tstaker, err := n.databaseClient.FindStakeStaker(c.Request().Context(), request.Address)\n+\tif err != nil {\n+\t\treturn fmt.Errorf(\"fetch stake staker by address %s: %w\", request.Address, err)\n+\t}\n+\n+\tresponse := GetStakerResponse(*staker)\n+\n+\treturn c.JSON(http.StatusOK, response)\n+}\n\nFile: internal/service/hub/server.go\nPatch:\n@@ -120,6 +120,11 @@ func NewServer(databaseClient database.Client, redisClient *redis.Client, geoLit\n \t\t\tnodes.POST(\"/:node_address/hide_tax_rate\", instance.hub.nta.PostNodeHideTaxRate)\n \t\t}\n \n+\t\tstakers := nta.Group(\"/stakers\")\n+\t\t{\n+\t\t\tstakers.GET(\"/:address\", instance.hub.nta.GetStaker)\n+\t\t}\n+\n \t\tsnapshots := nta.Group(\"/snapshots\")\n \t\t{\n \t\t\tsnapshots.GET(\"/nodes/count\", instance.hub.nta.GetNodeCountSnapshots)\n\nFile: schema/stake_staker.go\nPatch:\n@@ -0,0 +1,14 @@\n+package schema\n+\n+import (\n+\t\"github.com/ethereum/go-ethereum/common\"\n+\t\"github.com/shopspring/decimal\"\n+)\n+\n+type StakeStaker struct {\n+\tAddress             common.Address  `json:\"address\"`\n+\tTotalStakedNodes    uint64          `json:\"total_staked_nodes\"`\n+\tTotalChips          uint64          `json:\"total_chips\"`\n+\tTotalStakedTokens   decimal.Decimal `json:\"total_staked_tokens\"`\n+\tCurrentStakedTokens decimal.Decimal `json:\"current_staked_tokens\"`\n+}\n\n"
}