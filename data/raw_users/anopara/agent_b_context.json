{
  "username": "anopara",
  "agent_b_context": "\n=== PR #3 in EmbarkStudios/kajiya (Stars: 5227) ===\n\n=== PR #52 in EmbarkStudios/texture-synthesis (Stars: 1799) ===\nFile: lib/examples/07_repeat_transform.rs\nPatch:\n@@ -0,0 +1,25 @@\n+use texture_synthesis as ts;\n+\n+fn main() -> Result<(), ts::Error> {\n+    //create a new session\n+    let texsynth = ts::Session::builder()\n+        //load a single example image\n+        .add_example(&\"imgs/1.jpg\")\n+        .build()?;\n+\n+    //generate an image\n+    let generated = texsynth.run(None);\n+\n+    //now we can apply the same transformation of the generated image\n+    //onto a new image (which can be used to ensure 1-1 mapping between multiple images)\n+    //NOTE: it is important to provide same number and image dimensions as the examples used for synthesis\n+    //otherwise, there will be coordinates mismatch\n+    let repeat_transform_img = generated\n+        .get_coordinate_transform()\n+        .apply(&[\"imgs/1_bw.jpg\"])?;\n+\n+    //save the image to the disk\n+    //01 and 01_2 images should match perfectly\n+    repeat_transform_img.save(\"out/01_2.jpg\").unwrap();\n+    generated.save(\"out/01.jpg\")\n+}\n\nFile: lib/src/errors.rs\nPatch:\n@@ -54,6 +54,8 @@ pub enum Error {\n     /// There are no examples to source pixels from, either because no examples\n     /// were added, or all of them used SampleMethod::Ignore\n     NoExamples,\n+    ///\n+    MapsCountMismatch(u32, u32),\n }\n \n impl fmt::Display for Error {\n@@ -85,6 +87,11 @@ impl fmt::Display for Error {\n                 f,\n                 \"at least 1 example must be available as a sampling source\"\n             ),\n+            Self::MapsCountMismatch(input, required) => write!(\n+                f,\n+                \"{} map(s) were provided, but {} is/are required\",\n+                input, required\n+            ),\n         }\n     }\n }\n\nFile: lib/src/lib.rs\nPatch:\n@@ -76,6 +76,44 @@ impl Dims {\n     }\n }\n \n+pub struct CoordinateTransform {\n+    buffer: Vec<u32>,\n+    dims: Dims,\n+    max_map_id: u32, // total number of maps required to perform transformation\n+}\n+\n+impl<'a> CoordinateTransform {\n+    /// Applies the coordinate transformation from new source images. Important to ensure that you have same number and sizes of the images as during synthesis where the coordinate transform was saved from\n+    pub fn apply<E: Into<ImageSource<'a>>, I: IntoIterator<Item = E>>(\n+        &self,\n+        source: I,\n+    ) -> Result<image::RgbaImage, Error> {\n+        let ref_maps: Vec<image::RgbaImage> = source\n+            .into_iter()\n+            .map(|t| load_image(t.into(), None))\n+            .collect::<Result<Vec<_>, Error>>()?;\n+        //assert same number of maps\n+        if ref_maps.len() as u32 != self.max_map_id {\n+            return Err(Error::MapsCountMismatch(\n+                ref_maps.len() as u32,\n+                self.max_map_id,\n+       \n... (truncated)\n\nFile: lib/src/multires_stochastic_texture_synthesis.rs\nPatch:\n@@ -4,7 +4,7 @@ use rstar::RTree;\n use std::sync::atomic::{AtomicUsize, Ordering};\n use std::sync::{Mutex, RwLock};\n \n-use crate::{img_pyramid::*, unsync::*, Dims, SamplingMethod};\n+use crate::{img_pyramid::*, unsync::*, CoordinateTransform, Dims, SamplingMethod};\n \n #[derive(Debug)]\n pub struct GeneratorParams {\n@@ -697,6 +697,29 @@ impl Generator {\n         uncertainty_map\n     }\n \n+    pub fn get_coord_transform(&self) -> CoordinateTransform {\n+        //init empty 32bit image\n+        let mut buffer: Vec<u32> = Vec::new();\n+        let mut max_map_id = 1;\n+        //populate the image with colors\n+        for (coord, map_id) in self.coord_map.as_ref().iter() {\n+            // coord to color\n+            let r = coord.x;\n+            let g = coord.y;\n+            let b = map_id.0;\n+            if max_map_id < b {\n+                max_map_id = b;\n+            }\n+            //record the color\n+            buffer.extend_from_slice(&[r, g, b]);\n+        }\n+        CoordinateTransform {\n... (truncated)\n\nFile: lib/tests/diff.rs\nPatch:\n@@ -218,3 +218,35 @@ diff_hash!(tiling, \"JFSVUUmMaMzhWSttmlwojR1q\", {\n         )\n         .tiling_mode(true)\n });\n+\n+#[test]\n+fn repeat_transform() {\n+    //create a new session\n+    let texsynth = ts::Session::builder()\n+        .add_example(&\"../imgs/1.jpg\")\n+        .build()\n+        .unwrap();\n+\n+    let generated = texsynth.run(None);\n+\n+    let repeat_transform_img = generated\n+        .get_coordinate_transform()\n+        .apply(&[\"../imgs/1.jpg\"])\n+        .unwrap();\n+\n+    let hash_synthesized = ImageHash::hash(\n+        &MyPrecious(generated.into_image()),\n+        8,\n+        HashType::DoubleGradient,\n+    );\n+    let hash_repeated = ImageHash::hash(\n+        &MyPrecious(repeat_transform_img),\n+        8,\n+        HashType::DoubleGradient,\n+    );\n+\n+    assert_eq!(\n+        hash_synthesized, hash_repeated,\n+        \"repeated transform image hash differs from synthesized image\"\n+    );\n+}\n\n\n=== PR #1297 in rust-gamedev/rust-gamedev.github.io (Stars: 398) ===\n"
}